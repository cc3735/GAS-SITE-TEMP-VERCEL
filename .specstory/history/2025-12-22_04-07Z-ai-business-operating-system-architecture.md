<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 0b7262d9-2c23-4d9d-9fc3-dd5d6e35ddc8 (2025-12-22 04:07Z) -->

# AI business operating system architecture (2025-12-22 04:07Z)

_**User (2025-12-22 04:07Z)**_

Inside the @project/ folder,  Godview Identity layer for CRM/campaign

Phase 0 ( highly critical) : Phase 3: The "Mission Control" Dashboard
The "Why": Trust. Clients need to see that their AI employees are working. They need a dashboard that feels like an OS—giving them control over their agents, their sales, and their communications in one spot.

Architect's Note: This isn't a "report viewer"; it's a Management Suite.

Vibe Code Prompt (Frontend Experience): "Review our current frontend components and layout. We are building the 'Mission Control' interface for the Business Operating System.

The Vision: The user should feel like they are in the cockpit of their business. They need instant visibility into their AI workforce and their revenue streams without 'tab fatigue.'

What we need:

Agent Visibility: Design a component that visualizes AI Agents as active workers. I want to see live status indicators, recent transcript snippets, and performance analytics (success rates) at a glance.

The Unified Inbox: Create a 'Universal Communication Hub' interface. It should aggregate streams from SMS, Email, and Social DMs into a single thread per customer, allowing the tenant to reply from one place.

The 'Why': The tenant wants to feel in control. They need to be able to 'audit' an AI conversation instantly or take over if necessary.

Please generate the React/Next.js components that deliver this high-density, command-center aesthetic, utilizing our existing UI library."


Phase 1: The "God View" Identity Layer
The "Why": A customer isn't just a row in a database. They are a "Profile" that exists across multiple platforms. We need to track them holistically so the business owner sees the person, not just the transaction.

Architect's Note: We need the system to understand that "John Doe on Instagram" is the same as "John Doe on Shopify."

Vibe Code Prompt (Data Architecture): "Review our current database schema and project structure. We are pivoting to a 'Unified Business Operating System' architecture.

The Vision: We need to eliminate data silos. I need you to design a schema update that creates a 'Master Profile' for our tenants' customers.

What we need:

Unified Identity: A structure that links a single customer identity to their disparate digital footprints (Shopify Customer ID, Instagram Scoped ID, Phone Number, Email).

The 'Why': We need to show our tenants a complete history of a customer's journey—from their first ad click to their latest abandoned cart—in one single timeline.

Agent Oversight: We need a dedicated space in the schema to log AI Agent performance (Voice & Chat). We must track not just that they spoke, but what the sentiment was and if a human had to intervene.

Please propose the necessary schema changes to our existing prisma.schema (or SQL setup) to support this holistic 'God View' of the customer."


For @gasweb-site/  

Phase 2: The "Intake & Nudge" Engine
The "Why": Data without action is useless. We need Intake Automations. When a customer interacts (fills a form, abandons a cart), the system must immediately react to keep the business "in front of them."

Architect's Note: The goal is to prevent "lead decay." If a human forgets to follow up, the System remembers.

Vibe Code Prompt (Automation Logic): "Analyze our current backend logic. We are implementing a 'Proactive Campaign Engine' to handle Intake Automations.

The Vision: We cannot allow any lead to sit stagnant. The system must act as an 'Always-On' SDR and Support agent.

What we need:

Intelligent Routing: Create a logic flow that ingests webhooks (forms, cart activity) and instantly categorizes the user's intent (e.g., 'High Value Lead' vs. 'Window Shopper').

The 'Nudge' Mechanism: Implement a state machine that tracks 'Ghosting.' If a user starts a booking or purchase but stops, the system should automatically trigger a re-engagement workflow (email/SMS) after a set delay.

The 'Why': Our tenants are busy. They need the peace of mind that their 'Operating System' is working in the background to maximize conversion without them lifting a finger.

Based on our existing service layers, scaffold the business logic to handle these multi-stage, state-aware campaigns."

---

_**Agent (model default, mode Plan)**_



---


Reviewing the codebase to understand the current architecture before drafting the plan.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/package.json</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: gasweb-site/package.json</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/schema.prisma" • **0** result in **1** directory</summary>

Directory: **c:\Users\023du\OneDrive\Documents\GitHub\GAS-SITE-TEMP-VERCEL** (0 file)

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/*schema*.sql" • **17** results in **1** directory</summary>

Directory: **c:\Users\023du\OneDrive\Documents\GitHub\GAS-SITE-TEMP-VERCEL** (17 files)

| File |
|------|
| `supabase\migrations\20251210000005_create_construction_mgmt_schema.sql` |
| `supabase\migrations\20251210000004_create_food_truck_schema.sql` |
| `supabase\migrations\20251210000003_create_keys_open_doors_schema.sql` |
| `supabase\migrations\20251210000002_create_courses_schema.sql` |
| `supabase\migrations\20251210000001_create_landing_pages_schema.sql` |
| `supabase\migrations\20251119010000_create_rag_schema.sql` |
| `supabase\migrations\20251119000000_enhance_projects_schema.sql` |
| `supabase\migrations\20251114035624_create_marketing_social_media_schema.sql` |
| `supabase\migrations\20251114035511_create_ai_agents_mcp_schema.sql` |
| `supabase\migrations\20251114035415_create_crm_schema.sql` |
| `supabase\migrations\20251114035325_create_project_management_schema.sql` |
| `project\supabase\migrations\20251119010000_create_rag_schema.sql` |
| `project\supabase\migrations\20251119000000_enhance_projects_schema.sql` |
| `project\supabase\migrations\20251114035624_create_marketing_social_media_schema.sql` |
| `project\supabase\migrations\20251114035511_create_ai_agents_mcp_schema.sql` |
| `project\supabase\migrations\20251114035415_create_crm_schema.sql` |
| `project\supabase\migrations\20251114035325_create_project_management_schema.sql` |

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---



---





---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/supabase/migrations/20251114035415_create_crm_schema.sql</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/supabase/migrations/20251114035511_create_ai_agents_mcp_schema.sql</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/src/pages/Dashboard.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/src/pages/CRM.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/src/hooks/useContacts.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/src/hooks/useAgents.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/src/components/DashboardLayout.tsx</summary>

</details>
</tool-use>

---



---


Checking for existing marketing/social media schemas and backend automation logic:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/supabase/migrations/20251114035624_create_marketing_social_media_schema.sql</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How are webhooks or automation workflows currently handled in the backend?" • **9** results</summary>
            
| File | Lines |
|------|-------|
| `docs/integration/AI_OPERATING_INTEGRATION.md` | L295-355 |
| `supabase/migrations/20251114035624_create_marketing_social_media_schema.sql` | L170-222 |
| `project/supabase/migrations/20251114035624_create_marketing_social_media_schema.sql` | L170-222 |
| `business-apps/food-truck/src/routes/webhooks.ts` | L22-175 |
| `business-apps/food-truck/src/routes/webhooks.ts` | L109 |
| `docs/integration/AI_OPERATING_INTEGRATION.md` | L350-425 |
| `business-apps/keys-open-doors/src/routes/scraping.ts` | L59-171 |
| `project/src/lib/database.types.ts` | L6-2016 |
| `business-apps/food-truck/src/routes/webhooks.ts` | L23-175 |

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---



---


Asking a few clarifying questions to scope the plan:


---

<tool-use data-tool-type="unknown" data-tool-name="ask_question">
<details>
<summary>Tool use: **ask_question**</summary>


Parameters:

```json
{
  "questions": [
    {
      "id": "identity_resolution",
      "prompt": "For the \"God View\" Identity Layer (Phase 1), how should the system match identities across platforms? Should we use deterministic matching (exact email/phone match) or probabilistic matching (fuzzy matching, ML-based)?",
      "options": [
        {
          "id": "deterministic",
          "label": "Deterministic only (exact email/phone match)"
        },
        {
          "id": "probabilistic",
          "label": "Probabilistic (fuzzy matching, ML-based)"
        },
        {
          "id": "hybrid",
          "label": "Hybrid (deterministic first, then probabilistic for edge cases)"
        }
      ]
    },
    {
      "id": "communication_channels",
      "prompt": "For the Unified Inbox (Phase 0), which communication channels should be supported initially?",
      "options": [
        {
          "id": "email_sms_social",
          "label": "Email, SMS, and Social DMs (Instagram, Facebook)"
        },
        {
          "id": "email_sms_only",
          "label": "Email and SMS only"
        },
        {
          "id": "all_channels",
          "label": "All channels (Email, SMS, Social DMs, Voice, Forms)"
        }
      ]
    },
    {
      "id": "nudge_timing",
      "prompt": "For the Intake &amp; Nudge Engine (Phase 2), what should be the default delay before triggering a re-engagement workflow when a lead goes \"cold\"?",
      "options": [
        {
          "id": "24h",
          "label": "24 hours"
        },
        {
          "id": "48h",
          "label": "48 hours"
        },
        {
          "id": "72h",
          "label": "72 hours"
        },
        {
          "id": "configurable",
          "label": "Configurable per workflow (recommended)"
        }
      ]
    }
  ]
}
```
Additional data:

```json
{
  "status": "submitted",
  "currentSelections": {
    "identity_resolution": [
      "deterministic"
    ],
    "communication_channels": [
      "all_channels"
    ],
    "nudge_timing": [
      "configurable"
    ]
  }
}
```
Result:

```json
{
  "answers": [
    {
      "questionId": "identity_resolution",
      "selectedOptionIds": [
        "deterministic"
      ]
    },
    {
      "questionId": "communication_channels",
      "selectedOptionIds": [
        "all_channels"
      ]
    },
    {
      "questionId": "nudge_timing",
      "selectedOptionIds": [
        "configurable"
      ]
    }
  ]
}
```
User decision: **accepted**

Status: **completed**


</details>
</tool-use>

---



---


Creating the implementation plan:


---

<tool-use data-tool-type="unknown" data-tool-name="create_plan">
<details>
<summary>Tool use: **create_plan**</summary>


Parameters:

```json
{
  "plan": "# God View Identity Layer &amp; Mission Control Dashboard Implementation Plan\n\n## Architecture Overview\n\nThis plan implements three critical phases of the Business Operating System:\n- **Phase 0**: Mission Control Dashboard (command-center interface)\n- **Phase 1**: God View Identity Layer (unified customer profiles)\n- **Phase 2**: Intake &amp; Nudge Engine (proactive lead management)\n\n## Phase 0: Mission Control Dashboard (&#96;@project/&#96;)\n\n### Database Schema Updates\n**File**: &#96;project/supabase/migrations/[timestamp]_create_mission_control_schema.sql&#96;\n\nCreate tables for:\n- &#96;communication_threads&#96; - Unified threads per customer across all channels\n- &#96;communication_messages&#96; - Individual messages (email, SMS, social, voice)\n- &#96;agent_performance_logs&#96; - Real-time agent activity tracking\n- &#96;agent_transcripts&#96; - Conversation snippets for quick review\n\n### Frontend Components\n\n**1. Mission Control Dashboard Page**\n- **File**: &#96;project/src/pages/MissionControl.tsx&#96;\n- High-density command-center layout\n- Real-time agent status grid\n- Unified inbox preview\n- Revenue stream widgets\n\n**2. Agent Visibility Component**\n- **File**: &#96;project/src/components/AgentVisibility.tsx&#96;\n- Live status indicators (active/paused/error)\n- Recent transcript snippets\n- Performance metrics (success rate, tasks completed)\n- Quick action buttons (pause/resume/view details)\n\n**3. Unified Inbox Component**\n- **File**: &#96;project/src/components/UnifiedInbox.tsx&#96;\n- Threaded view per customer\n- Channel indicators (Email/SMS/Social/Voice)\n- Reply interface supporting all channels\n- Conversation timeline with AI/human indicators\n\n**4. Agent Performance Widget**\n- **File**: &#96;project/src/components/AgentPerformanceWidget.tsx&#96;\n- Success rate visualization\n- Recent activity feed\n- Intervention tracking (human takeovers)\n\n### Hooks &amp; Services\n- **File**: &#96;project/src/hooks/useAgentPerformance.ts&#96; - Real-time agent metrics\n- **File**: &#96;project/src/hooks/useUnifiedInbox.ts&#96; - Thread aggregation\n- **File**: &#96;project/src/services/communicationService.ts&#96; - Multi-channel messaging\n\n## Phase 1: God View Identity Layer (&#96;@project/&#96;)\n\n### Database Schema Updates\n**File**: &#96;project/supabase/migrations/[timestamp]_create_god_view_identity_schema.sql&#96;\n\n**New Tables:**\n1. &#96;customer_profiles&#96; - Master profile table\n   - Links to contacts, but extends with unified identity\n   - Stores merged customer data\n   - Tracks identity confidence score\n\n2. &#96;identity_links&#96; - Platform identity mapping\n   - Links customer_profile_id to platform-specific IDs\n   - Stores: Shopify Customer ID, Instagram Scoped ID, Email, Phone\n   - Tracks source platform and verification status\n\n3. &#96;customer_journey_events&#96; - Unified timeline\n   - Tracks all touchpoints: ad clicks, form submissions, cart abandons, purchases\n   - Links to source platform events\n   - Chronological event stream\n\n4. &#96;agent_interaction_logs&#96; - AI agent oversight\n   - Links to voice_agent_calls and chat interactions\n   - Stores sentiment analysis\n   - Tracks human intervention flags\n   - Performance metrics per interaction\n\n**Migration Strategy:**\n- Create function to merge existing contacts into customer_profiles\n- Backfill identity_links from existing contact data\n- Migrate activities to customer_journey_events\n\n### Identity Resolution Logic\n**File**: &#96;project/supabase/functions/resolve-customer-identity/index.ts&#96;\n\nDeterministic matching algorithm:\n1. Exact email match (highest priority)\n2. Exact phone match (normalized)\n3. Name + company match (fallback)\n4. Create new profile if no match\n\n### Frontend Components\n\n**1. Customer Profile View**\n- **File**: &#96;project/src/pages/CustomerProfile.tsx&#96;\n- Unified timeline showing all touchpoints\n- Platform identity badges\n- Agent interaction history\n- Journey visualization\n\n**2. Identity Resolution Service**\n- **File**: &#96;project/src/services/identityResolution.ts&#96;\n- Client-side identity matching\n- Profile merging UI\n- Conflict resolution interface\n\n### Hooks\n- **File**: &#96;project/src/hooks/useCustomerProfile.ts&#96; - Unified profile data\n- **File**: &#96;project/src/hooks/useCustomerJourney.ts&#96; - Timeline events\n\n## Phase 2: Intake &amp; Nudge Engine (&#96;@gasweb-site/&#96;)\n\n### Database Schema Updates\n**File**: &#96;gasweb-site/supabase/migrations/[timestamp]_create_intake_nudge_schema.sql&#96;\n\n**New Tables:**\n1. &#96;lead_intake_events&#96; - Webhook ingestion\n   - Stores form submissions, cart events, page views\n   - Categorizes intent (High Value Lead, Window Shopper, etc.)\n   - Links to customer_profiles\n\n2. &#96;lead_states&#96; - State machine tracking\n   - Current state: new, engaged, ghosting, converted, lost\n   - State transitions with timestamps\n   - Context data (last activity, engagement score)\n\n3. &#96;nudge_campaigns&#96; - Re-engagement workflows\n   - Configurable delay timers\n   - Multi-stage sequences\n   - Channel preferences (email/SMS)\n\n4. &#96;nudge_executions&#96; - Campaign execution log\n   - Tracks sent nudges\n   - Response tracking\n   - Conversion attribution\n\n### Backend Services\n\n**1. Webhook Handler**\n- **File**: &#96;gasweb-site/supabase/functions/intake-webhook/index.ts&#96;\n- Accepts webhooks from forms, Shopify, etc.\n- Categorizes intent using rules engine\n- Creates/updates lead_states\n- Triggers immediate routing logic\n\n**2. Intent Classification Service**\n- **File**: &#96;gasweb-site/src/services/intentClassifier.ts&#96;\n- Rules-based classification:\n  - High Value: Form with budget field, cart &gt; $X\n  - Window Shopper: Browse only, no form\n  - Engaged: Multiple page views, form started\n- Extensible for ML-based classification later\n\n**3. Lead State Machine**\n- **File**: &#96;gasweb-site/src/services/leadStateMachine.ts&#96;\n- Manages state transitions:\n  - new → engaged (on first interaction)\n  - engaged → ghosting (after inactivity threshold)\n  - ghosting → converted (on purchase/booking)\n  - ghosting → lost (after max nudge attempts)\n- Configurable thresholds per organization\n\n**4. Nudge Automation Engine**\n- **File**: &#96;gasweb-site/supabase/functions/nudge-processor/index.ts&#96;\n- Scheduled function (runs every hour)\n- Checks for leads in \"ghosting\" state past delay threshold\n- Executes nudge campaigns based on workflow rules\n- Updates lead_states on response\n\n### Frontend Components\n\n**1. Intake Dashboard**\n- **File**: &#96;gasweb-site/src/pages/IntakeDashboard.tsx&#96;\n- Real-time lead feed\n- Intent classification display\n- State distribution visualization\n\n**2. Nudge Campaign Builder**\n- **File**: &#96;gasweb-site/src/components/NudgeCampaignBuilder.tsx&#96;\n- Visual workflow builder\n- Delay configuration\n- Channel selection\n- A/B testing setup\n\n### Configuration\n- **File**: &#96;gasweb-site/src/config/nudgeDefaults.ts&#96;\n- Default delay timers\n- State transition rules\n- Intent classification thresholds\n\n## Integration Points\n\n### Cross-Phase Integration\n1. **Mission Control → God View**: Click customer in inbox → view full profile\n2. **God View → Intake**: Journey events include intake events\n3. **Intake → Mission Control**: New leads appear in dashboard\n4. **Nudge → Unified Inbox**: Nudge responses appear in threads\n\n### External Integrations\n- Shopify webhooks (cart events, purchases)\n- Form submission webhooks (custom forms)\n- Email service (SendGrid/Mailgun for nudges)\n- SMS service (Twilio for nudges)\n- Social platforms (Instagram/Facebook DMs)\n\n## Data Flow Diagrams\n\n### Identity Resolution Flow\n&#96;&#96;&#96;\nWebhook/Form → Extract Identity → Check Existing Profiles\n  → Match Found? → Link Identity → Update Journey\n  → No Match → Create Profile → Link Identity → Create Journey Event\n&#96;&#96;&#96;\n\n### Nudge Automation Flow\n&#96;&#96;&#96;\nScheduled Job → Query Ghosting Leads → Check Delay Threshold\n  → Threshold Met? → Load Nudge Campaign → Execute (Email/SMS)\n  → Update Execution Log → Update Lead State\n&#96;&#96;&#96;\n\n## Security &amp; RLS\n- All new tables include &#96;organization_id&#96; for multi-tenant isolation\n- RLS policies follow existing patterns (members can view, admins can manage)\n- Webhook endpoints require organization-scoped authentication\n- Identity resolution respects data privacy (no cross-org matching)\n\n## Testing Strategy\n- Unit tests for identity resolution logic\n- Integration tests for webhook handlers\n- E2E tests for nudge automation workflows\n- Performance tests for real-time dashboard updates\n\n## Migration Notes\n- Phase 1 migration includes data backfill scripts\n- Phase 2 can run independently (doesn't require Phase 1)\n- All migrations are backward-compatible (additive only)",
  "name": "God View Identity &amp; Mission Control",
  "todos": [
    {
      "content": "Create Mission Control database schema (communication_threads, communication_messages, agent_performance_logs, agent_transcripts)",
      "status": "pending",
      "id": "phase0-schema"
    },
    {
      "content": "Build AgentVisibility component with live status, transcripts, and performance metrics",
      "status": "pending",
      "id": "phase0-agent-visibility",
      "dependencies": [
        "phase0-schema"
      ]
    },
    {
      "content": "Build UnifiedInbox component with threaded view and multi-channel reply interface",
      "status": "pending",
      "id": "phase0-unified-inbox",
      "dependencies": [
        "phase0-schema"
      ]
    },
    {
      "content": "Create MissionControl dashboard page integrating AgentVisibility and UnifiedInbox",
      "status": "pending",
      "id": "phase0-dashboard",
      "dependencies": [
        "phase0-agent-visibility",
        "phase0-unified-inbox"
      ]
    },
    {
      "content": "Create God View identity schema (customer_profiles, identity_links, customer_journey_events, agent_interaction_logs)",
      "status": "pending",
      "id": "phase1-schema"
    },
    {
      "content": "Implement identity resolution function with deterministic matching (email/phone/name+company)",
      "status": "pending",
      "id": "phase1-resolution",
      "dependencies": [
        "phase1-schema"
      ]
    },
    {
      "content": "Create migration script to backfill customer_profiles from existing contacts",
      "status": "pending",
      "id": "phase1-migration",
      "dependencies": [
        "phase1-schema",
        "phase1-resolution"
      ]
    },
    {
      "content": "Build CustomerProfile page with unified timeline and platform identity badges",
      "status": "pending",
      "id": "phase1-profile-view",
      "dependencies": [
        "phase1-schema"
      ]
    },
    {
      "content": "Create Intake &amp; Nudge schema (lead_intake_events, lead_states, nudge_campaigns, nudge_executions)",
      "status": "pending",
      "id": "phase2-schema"
    },
    {
      "content": "Build webhook handler function for form/cart events with intent classification",
      "status": "pending",
      "id": "phase2-webhook",
      "dependencies": [
        "phase2-schema"
      ]
    },
    {
      "content": "Implement lead state machine service with configurable transitions and thresholds",
      "status": "pending",
      "id": "phase2-state-machine",
      "dependencies": [
        "phase2-schema"
      ]
    },
    {
      "content": "Build nudge automation engine with scheduled processing and multi-channel execution",
      "status": "pending",
      "id": "phase2-nudge-engine",
      "dependencies": [
        "phase2-schema",
        "phase2-state-machine"
      ]
    },
    {
      "content": "Create IntakeDashboard page with real-time lead feed and state visualization",
      "status": "pending",
      "id": "phase2-dashboard",
      "dependencies": [
        "phase2-schema"
      ]
    },
    {
      "content": "Test cross-phase integrations (Mission Control → God View, Intake → Inbox, etc.)",
      "status": "pending",
      "id": "integration-testing",
      "dependencies": [
        "phase0-dashboard",
        "phase1-profile-view",
        "phase2-dashboard"
      ]
    }
  ],
  "overview": "Implement a unified Business Operating System with Mission Control dashboard, God View identity layer for holistic customer tracking, and Intake &amp; Nudge automation engine to prevent lead decay."
}
```
Additional data:

```json
{
  "reviewData": {
    "status": "Requested",
    "selectedOption": "none",
    "isShowingInput": false
  },
  "planUri": "file:///c%3A/Users/023du/.cursor/plans/god_view_identity_%26_mission_control_ab6dec5b.plan.md",
  "hasOpenedEditor": true,
  "pinnedName": "God View Identity &amp; Mission Control"
}
```
Result:

```json
{
  "accepted": {
    "finalTodos": [
      {
        "content": "Create Mission Control database schema (communication_threads, communication_messages, agent_performance_logs, agent_transcripts)",
        "status": "pending",
        "id": "phase0-schema"
      },
      {
        "content": "Build AgentVisibility component with live status, transcripts, and performance metrics",
        "status": "pending",
        "id": "phase0-agent-visibility"
      },
      {
        "content": "Build UnifiedInbox component with threaded view and multi-channel reply interface",
        "status": "pending",
        "id": "phase0-unified-inbox"
      },
      {
        "content": "Create MissionControl dashboard page integrating AgentVisibility and UnifiedInbox",
        "status": "pending",
        "id": "phase0-dashboard"
      },
      {
        "content": "Create God View identity schema (customer_profiles, identity_links, customer_journey_events, agent_interaction_logs)",
        "status": "pending",
        "id": "phase1-schema"
      },
      {
        "content": "Implement identity resolution function with deterministic matching (email/phone/name+company)",
        "status": "pending",
        "id": "phase1-resolution"
      },
      {
        "content": "Create migration script to backfill customer_profiles from existing contacts",
        "status": "pending",
        "id": "phase1-migration"
      },
      {
        "content": "Build CustomerProfile page with unified timeline and platform identity badges",
        "status": "pending",
        "id": "phase1-profile-view"
      },
      {
        "content": "Create Intake &amp; Nudge schema (lead_intake_events, lead_states, nudge_campaigns, nudge_executions)",
        "status": "pending",
        "id": "phase2-schema"
      },
      {
        "content": "Build webhook handler function for form/cart events with intent classification",
        "status": "pending",
        "id": "phase2-webhook"
      },
      {
        "content": "Implement lead state machine service with configurable transitions and thresholds",
        "status": "pending",
        "id": "phase2-state-machine"
      },
      {
        "content": "Build nudge automation engine with scheduled processing and multi-channel execution",
        "status": "pending",
        "id": "phase2-nudge-engine"
      },
      {
        "content": "Create IntakeDashboard page with real-time lead feed and state visualization",
        "status": "pending",
        "id": "phase2-dashboard"
      },
      {
        "content": "Test cross-phase integrations (Mission Control → God View, Intake → Inbox, etc.)",
        "status": "pending",
        "id": "integration-testing"
      }
    ]
  },
  "planUri": "c:\\Users\\023du\\.cursor\\plans\\god_view_identity_&amp;_mission_control_ab6dec5b.plan.md"
}
```
Status: **completed**


</details>
</tool-use>

---

_**User (2025-12-22 04:07Z)**_

What other questions about the mission control dashboard would you like me to address to make it as ready as possible initially? 

---

_**Agent (model default, mode Ask)**_



---


Reviewing the current dashboard structure to identify critical questions for the Mission Control dashboard:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/src/pages/Dashboard.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How are real-time updates currently handled in the frontend? WebSockets, polling, or Supabase subscriptions?" • **9** results</summary>
            
| File | Lines |
|------|-------|
| `project/src/hooks/useSync.ts` | L17-200 |
| `gasweb-site/docs/API_DOCUMENTATION.md` | L409-537 |
| `business-apps/construction-mgmt/docs/TRANSLATION_SYSTEM.md` | L274-363 |
| `gasweb-site/docs/ARCHITECTURE.md` | L206-289 |
| `project/src/hooks/useMCPServers.ts` | L5-103 |
| `business-apps/construction-mgmt/docs/API_REFERENCE.md` | L802-918 |
| `docs/integration/AI_OPERATING_INTEGRATION.md` | L44-130 |
| `gasweb-site/src/lib/supabase.ts` | L84 |
| `project/src/hooks/useAgents.ts` | L5-153 |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: project/src/hooks/useAgents.ts</summary>

</details>
</tool-use>

---



---


Here are the critical questions to finalize the Mission Control dashboard design:

## Critical Design Questions

### 1. **Agent Status Granularity**
What statuses should agents display?
- Basic: `active`, `paused`, `error`
- Detailed: `active`, `idle`, `processing`, `paused`, `error`, `offline`
- With context: `active (handling 3 conversations)`, `idle (waiting)`, `error (API timeout)`

### 2. **Performance Metrics Priority**
Which metrics should be visible at a glance?
- Success rate (conversions/resolved)
- Response time (avg time to first response)
- Cost per interaction (tokens/cost)
- Human intervention rate (% requiring takeover)
- Customer satisfaction (sentiment score)

### 3. **Unified Inbox Filtering & Search**
How should users navigate the inbox?
- Filter by: channel (Email/SMS/Social), status (unread/assigned/resolved), agent (AI vs human), priority
- Search by: customer name, email, phone, conversation content
- Sort by: most recent, oldest unread, priority, customer value

### 4. **Human Takeover Workflow**
When a human takes over, what should happen?
- Immediate: Button to "Take Over" → agent pauses → human can see full context
- Escalation: Agent flags for review → appears in "Needs Attention" queue
- Seamless handoff: Agent provides summary → human continues thread → agent resumes if needed

### 5. **Dashboard Layout & Customization**
What layout approach?
- Fixed grid: predefined widget positions (simpler, faster)
- Customizable: drag-and-drop widgets (more flexible, more complex)
- Tabbed sections: Agents / Inbox / Analytics (reduces clutter)

### 6. **Alerting & Notifications**
What events should trigger alerts?
- Agent failures (error status, API timeouts)
- High-priority messages (sentiment negative, VIP customer)
- Performance thresholds (success rate drops below X%)
- Human intervention needed (agent requests help)

### 7. **Transcript Display Detail**
How much conversation detail should be shown?
- Snippets only: Last 2-3 messages per agent (quick scan)
- Full transcripts: Expandable view with full conversation history
- Smart summaries: AI-generated summaries with expandable details

### 8. **Historical Data vs Real-Time**
What time range should be displayed?
- Real-time only: Last 24 hours of activity
- Recent history: Last 7 days with real-time updates
- Full history: All-time with date range filters

### 9. **Mobile Responsiveness**
Should Mission Control be mobile-friendly initially?
- Desktop-only: Focus on desktop experience first (faster to build)
- Mobile-responsive: Responsive grid that adapts (more work, better UX)
- Mobile app: Separate mobile interface (future phase)

### 10. **Revenue Stream Integration**
What revenue metrics should be visible?
- Real-time: Today's revenue, active deals, pipeline value
- Trends: Revenue over time, conversion rates
- Attribution: Revenue linked to agent interactions

---

## Recommendation Priority

Most critical for initial launch:
1. Agent status granularity (#1) — affects data model
2. Human takeover workflow (#4) — core trust feature
3. Unified Inbox filtering (#3) — usability
4. Alerting strategy (#6) — proactive monitoring

Can be refined later:
- Dashboard layout customization (#5)
- Mobile responsiveness (#9)
- Historical data depth (#8)

Which of these should we prioritize for the initial implementation?

---

_**User (2025-12-22 04:07Z)**_

The Agent Status Granularity should have context. 

At a glance, for performance, success rate, response time, cost per interaction, and customer satisfaction would be good metrics. 

Users should have the flexibility to navigate and search by all of them. 

Filter by: channel (Email/SMS/Social), status (unread/assigned/resolved), agent (AI vs human), priority
Search by: customer name, email, phone, conversation content
Sort by: most recent, oldest unread, priority, customer value

Regarding the human takeover workflow, Escalation: Agent flags for review → appears in "Needs Attention" queue if human deemed offline. IF human is deemed online, Seamless handoff: Agent provides summary → human continues thread → agent resumes if needed 

Tabbed Sections layout by clever categories are fine. 

Alerts /Notifications should be configurable for the following : Agent failures (error status, API timeouts)
High-priority messages (sentiment negative, VIP customer)
Performance thresholds (success rate drops below X%)
Human intervention needed (agent requests help)

For Historical Data vs Real Time - Full history: All-time with date range filters . 

Focus on Desktop experience first. 

---

_**Agent (model default, mode Ask)**_



---


Updating the implementation plan with these specifications. Here’s how these requirements map to the architecture:

## Updated Architecture Decisions

### 1. Agent Status with Context
**Implementation:**
- Extend `agent_performance_logs` to track current workload (active conversations count)
- Status display: `active (handling 3 conversations)`, `idle (waiting)`, `error (API timeout)`
- Real-time updates via Supabase subscriptions

### 2. Performance Metrics Dashboard
**Widget Layout:**
- Success Rate: Percentage with trend indicator
- Avg Response Time: Seconds with target comparison
- Cost Per Interaction: $ amount with daily total
- Customer Satisfaction: Sentiment score (0-100) with trend

### 3. Unified Inbox - Full Navigation
**Component Structure:**
```typescript
// Filter state structure
interface InboxFilters {
  channels: ('email' | 'sms' | 'social' | 'voice')[];
  status: ('unread' | 'assigned' | 'resolved')[];
  agentType: ('ai' | 'human' | 'both');
  priority: ('low' | 'medium' | 'high' | 'urgent')[];
}

// Search state
interface InboxSearch {
  query: string; // Searches: name, email, phone, content
  searchFields: string[];
}

// Sort options
type SortOption = 
  | 'most_recent' 
  | 'oldest_unread' 
  | 'priority' 
  | 'customer_value';
```

### 4. Human Takeover Workflow (Dual Mode)
**Database Schema Addition:**
```sql
-- Add to communication_threads
human_online_status boolean DEFAULT false;
escalation_queue boolean DEFAULT false;
handoff_summary text;
handoff_timestamp timestamptz;
```

**Logic Flow:**
1. Agent flags for review → Check `human_online_status`
2. If offline: Set `escalation_queue = true` → Appears in "Needs Attention" tab
3. If online: Generate summary → Create handoff event → Human receives notification → Seamless continuation

### 5. Tabbed Sections Layout
**Proposed Tabs:**
- **Command Center**: Agent grid + performance metrics
- **Unified Inbox**: All conversations with filters
- **Needs Attention**: Escalated items + intervention queue
- **Analytics**: Historical performance + trends
- **Alerts**: Active notifications + alert history

### 6. Configurable Alert System
**Database Schema:**
```sql
CREATE TABLE alert_rules (
  id uuid PRIMARY KEY,
  organization_id uuid REFERENCES organizations(id),
  rule_type text, -- 'agent_failure', 'high_priority', 'performance_threshold', 'intervention_needed'
  conditions jsonb, -- Threshold values, criteria
  channels text[], -- 'dashboard', 'email', 'sms'
  is_active boolean DEFAULT true
);
```

**Alert Types:**
- Agent failures: Error status detection + API timeout monitoring
- High-priority: Sentiment < threshold OR VIP customer flag
- Performance: Success rate < X% OR response time > Y seconds
- Intervention: Agent requests help flag

### 7. Full History with Date Range Filters
**Implementation:**
- Default view: Last 30 days
- Date range picker: Custom start/end dates
- Filter persistence: Save user preferences
- Performance: Pagination for large date ranges

### 8. Desktop-First Design
**Layout Strategy:**
- Fixed width: 1920px max container
- Grid system: 12-column responsive grid (desktop optimized)
- No mobile breakpoints initially
- Touch-friendly targets (min 44px)

## Updated Component Structure

### Mission Control Dashboard (`MissionControl.tsx`)
**Tab Structure:**
```typescript
<Tabs>
  <Tab id="command-center" label="Command Center">
    <AgentVisibility />
    <PerformanceMetrics />
  </Tab>
  <Tab id="inbox" label="Unified Inbox">
    <UnifiedInbox 
      filters={filters}
      search={search}
      sort={sort}
    />
  </Tab>
  <Tab id="attention" label="Needs Attention">
    <EscalationQueue />
    <InterventionQueue />
  </Tab>
  <Tab id="analytics" label="Analytics">
    <HistoricalAnalytics dateRange={dateRange} />
  </Tab>
  <Tab id="alerts" label="Alerts">
    <AlertCenter />
  </Tab>
</Tabs>
```

### Enhanced Components Needed

1. **AgentVisibility.tsx** - Status with context
2. **PerformanceMetrics.tsx** - 4-metric dashboard
3. **UnifiedInbox.tsx** - Full filtering/search/sort
4. **EscalationQueue.tsx** - Offline escalations
5. **HandoffInterface.tsx** - Online seamless handoff
6. **AlertCenter.tsx** - Configurable alerts
7. **HistoricalAnalytics.tsx** - Date range filtered history
8. **AlertRuleBuilder.tsx** - Alert configuration UI

## Database Schema Updates Required

### New Tables:
1. `alert_rules` - Configurable alert definitions
2. `human_online_status` - Track human availability (or extend `organization_members`)
3. `handoff_events` - Track seamless handoffs
4. `alert_history` - Alert firing log

### Enhanced Tables:
1. `communication_threads` - Add escalation/handoff fields
2. `agent_performance_logs` - Add context fields (active_conversations, current_task)
3. `communication_messages` - Add priority, sentiment fields

## Next Steps

1. Update the plan file with these specifications
2. Create detailed component specifications
3. Design the database migration scripts
4. Create wireframes/mockups for the tabbed layout

Should I:
- Update the plan file with these details?
- Create detailed component specifications?
- Design the database schema changes?
- Create a visual layout mockup in code?

Which should I prioritize?

---

_**User (2025-12-22 04:07Z)**_

Update the plan file with these specifications
Create detailed component specifications
Design the database migration scripts
Create wireframes/mockups for the tabbed layout  Also, use this screenshot as a User Interface design mockup of what the Mission Control Dashboard would look like.  I've also attached what the God View User Interface could be. Include these options as design options from a ui/ux perspective. 

---

_**Agent (model default, mode Plan)**_



---


Updating the plan with the specifications and adding detailed component specs, database migrations, and UI/UX design notes based on the screenshots. Reading the current plan first:


---

Could not find file '.cursor/plans/god_view_identity_&_mission_control_ab6dec5b.plan.md' in the workspace.

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/*plan*.md" • **0** result in **1** directory</summary>

Directory: **c:\Users\023du\OneDrive\Documents\GitHub\GAS-SITE-TEMP-VERCEL** (0 file)

</details>
</tool-use>

---



---





---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: c:\Users\023du\.cursor\plans\god_view_identity_&_mission_control_ab6dec5b.plan.md</summary>

</details>
</tool-use>

---



---


Updating the plan with detailed specifications, component specs, database migrations, and UI/UX design notes:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: c:\Users\023du\.cursor\plans\god_view_identity_&_mission_control_ab6dec5b.plan.md</summary>

</details>
</tool-use>

---



---


Updating the plan with detailed specifications, component specs, database migrations, and UI/UX design notes:


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: c:\Users\023du\.cursor\plans\god_view_identity_&_mission_control_ab6dec5b.plan.md</summary>

**Chunk 1**
Lines added: 1174, lines removed: 427

```diff
@@ -4,442 +4,1189 @@
  todos:
    - id: phase0-schema
-     content: Create Mission Control database schema (communication_threads, communication_messages, agent_performance_logs, agent_transcripts)
+     content: Create Mission Control database schema (communication_threads, communication_messages, agent_performance_logs, agent_transcripts, alert_rules, handoff_events)
...
-     content: Build AgentVisibility component with live status, transcripts, and performance metrics
+     content: Build AgentVisibility component with contextual status, live transcripts, and performance metrics
...
-     content: Build UnifiedInbox component with threaded view and multi-channel reply interface
+     content: Build UnifiedInbox component with full filtering/search/sort and multi-channel reply interface
...
-   - id: phase0-dashboard
-     content: Create MissionControl dashboard page integrating AgentVisibility and UnifiedInbox
+   - id: phase0-alert-system
+     content: Build configurable alert system with rule builder and notification center
...
-       - phase0-agent-visibility
-       - phase0-unified-inbox
-   - id: phase1-schema
-     content: Create God View identity schema (customer_profiles, identity_links, customer_journey_events, agent_interaction_logs)
+       - phase0-schema
+   - id: phase0-dashboard
+     content: Create MissionControl dashboard page with tabbed layout (Command Center, Unified Inbox, Needs Attention, Analytics, Alerts)
...
-   - id: phase1-resolution
-     content: Implement identity resolution function with deterministic matching (email/phone/name+company)
-     status: pending
-     dependencies:
-       - phase1-schema
-   - id: phase1-migration
-     content: Create migration script to backfill customer_profiles from existing contacts
-     status: pending
-     dependencies:
-       - phase1-schema
-       - phase1-resolution
-   - id: phase1-profile-view
-     content: Build CustomerProfile page with unified timeline and platform identity badges
-     status: pending
-     dependencies:
-       - phase1-schema
-   - id: phase2-schema
-     content: Create Intake &amp; Nudge schema (lead_intake_events, lead_states, nudge_campaigns, nudge_executions)
-     status: pending
-   - id: phase2-webhook
-     content: Build webhook handler function for form/cart events with intent classification
-     status: pending
+     dependencies:
+       - phase0-agent-visibility
+       - phase0-unified-inbox
+       - phase0-alert-system
+   - id: phase1-schema
+     content: Create God View identity schema (customer_profiles, identity_links, customer_journey_events, agent_interaction_logs)
+     status: pending
+   - id: phase1-resolution
+     content: Implement identity resolution function with deterministic matching (email/phone/name+company)
+     status: pending
+     dependencies:
+       - phase1-schema
+   - id: phase1-migration
+     content: Create migration script to backfill customer_profiles from existing contacts
+     status: pending
+     dependencies:
+       - phase1-schema
+       - phase1-resolution
+   - id: phase1-profile-view
+     content: Build CustomerProfile page with unified timeline, platform identity badges, and agent history
+     status: pending
...
-       - phase2-schema
-   - id: phase2-state-machine
-     content: Implement lead state machine service with configurable transitions and thresholds
-     status: pending
-     dependencies:
-       - phase2-schema
-   - id: phase2-nudge-engine
-     content: Build nudge automation engine with scheduled processing and multi-channel execution
-     status: pending
-     dependencies:
-       - phase2-schema
-       - phase2-state-machine
-   - id: phase2-dashboard
-     content: Create IntakeDashboard page with real-time lead feed and state visualization
-     status: pending
-     dependencies:
-       - phase2-schema
-   - id: integration-testing
-     content: Test cross-phase integrations (Mission Control → God View, Intake → Inbox, etc.)
-     status: pending
-     dependencies:
-       - phase0-dashboard
-       - phase1-profile-view
-       - phase2-dashboard
- ---
- 
- # God View Identity Layer &amp;
- 
- Mission Control Dashboard Implementation Plan
- 
- ## Architecture Overview
- 
- This plan implements three critical phases of the Business Operating System:
- 
- - **Phase 0**: Mission Control Dashboard (command-center interface)
- 
- - **Phase 1**: God View Identity Layer (unified customer profiles)
- 
- - **Phase 2**: Intake &amp; Nudge Engine (proactive lead management)
- 
- ## Phase 0: Mission Control Dashboard (&#96;@project/&#96;)
- 
- ### Database Schema Updates
- 
- **File**: &#96;project/supabase/migrations/[timestamp]_create_mission_control_schema.sql&#96;Create tables for:
- 
- - &#96;communication_threads&#96; - Unified threads per customer across all channels
- 
- - &#96;communication_messages&#96; - Individual messages (email, SMS, social, voice)
- 
- - &#96;agent_performance_logs&#96; - Real-time agent activity tracking
- 
- - &#96;agent_transcripts&#96; - Conversation snippets for quick review
- 
- ### Frontend Components
- 
- **1. Mission Control Dashboard Page**
- 
- - **File**: &#96;project/src/pages/MissionControl.tsx&#96;
- 
- - High-density command-center layout
- 
- - Real-time agent status grid
- 
- - Unified inbox preview
- 
- - Revenue stream widgets
- 
- **2. Agent Visibility Component**
- 
- - **File**: &#96;project/src/components/AgentVisibility.tsx&#96;
- 
- - Live status indicators (active/paused/error)
- 
- - Recent transcript snippets
- 
- - Performance metrics (success rate, tasks completed)
- 
- - Quick action buttons (pause/resume/view details)
- 
- **3. Unified Inbox Component**
- 
- - **File**: &#96;project/src/components/UnifiedInbox.tsx&#96;
- 
- - Threaded view per customer
- 
- - Channel indicators (Email/SMS/Social/Voice)
- 
- - Reply interface supporting all channels
- 
- - Conversation timeline with AI/human indicators
- 
- **4. Agent Performance Widget**
- 
- - **File**: &#96;project/src/components/AgentPerformanceWidget.tsx&#96;
- 
- - Success rate visualization
- 
- - Recent activity feed
- 
- - Intervention tracking (human takeovers)
- 
- ### Hooks &amp; Services
- 
- - **File**: &#96;project/src/hooks/useAgentPerformance.ts&#96; - Real-time agent metrics
- 
- - **File**: &#96;project/src/hooks/useUnifiedInbox.ts&#96; - Thread aggregation
- 
- - **File**: &#96;project/src/services/communicationService.ts&#96; - Multi-channel messaging
- 
- ## Phase 1: God View Identity Layer (&#96;@project/&#96;)
- 
- ### Database Schema Updates
- 
- **File**: &#96;project/supabase/migrations/[timestamp]_create_god_view_identity_schema.sql&#96;
- 
- **New Tables:**
- 
- 1. &#96;customer_profiles&#96; - Master profile table
- 
- - Links to contacts, but extends with unified identity
- 
- - Stores merged customer data
- 
- - Tracks identity confidence score
- 
- 2. &#96;identity_links&#96; - Platform identity mapping
- 
- - Links customer_profile_id to platform-specific IDs
- 
- - Stores: Shopify Customer ID, Instagram Scoped ID, Email, Phone
- 
- - Tracks source platform and verification status
- 
- 3. &#96;customer_journey_events&#96; - Unified timeline
- 
- - Tracks all touchpoints: ad clicks, form submissions, cart abandons, purchases
- 
- - Links to source platform events
- 
- - Chronological event stream
- 
- 4. &#96;agent_interaction_logs&#96; - AI agent oversight
- 
- - Links to voice_agent_calls and chat interactions
- 
- - Stores sentiment analysis
- - Tracks human intervention flags
- 
- - Performance metrics per interaction
- 
- **Migration Strategy:**
- 
- - Create function to merge existing contacts into customer_profiles
- 
- - Backfill identity_links from existing contact data
- - Migrate activities to customer_journey_events
- 
- ### Identity Resolution Logic
- 
- **File**: &#96;project/supabase/functions/resolve-customer-identity/index.ts&#96;
- 
- Deterministic matching algorithm:
- 
- 1. Exact email match (highest priority)
- 
- 2. Exact phone match (normalized)
- 
- 3. Name + company match (fallback)
- 
- 4. Create new profile if no match
- 
- ### Frontend Components
- 
- **1. Customer Profile View**
- 
- - **File**: &#96;project/src/pages/CustomerProfile.tsx&#96;
- 
- - Unified timeline showing all touchpoints
- 
- - Platform identity badges
- - Agent interaction history
- - Journey visualization
- 
- **2. Identity Resolution Service**
- 
- - **File**: &#96;project/src/services/identityResolution.ts&#96;
- 
- - Client-side identity matching
- 
- - Profile merging UI
- 
- - Conflict resolution interface
- 
- ### Hooks
- 
- - **File**: &#96;project/src/hooks/useCustomerProfile.ts&#96; - Unified profile data
- 
- - **File**: &#96;project/src/hooks/useCustomerJourney.ts&#96; - Timeline events
- 
- ## Phase 2: Intake &amp; Nudge Engine (&#96;@gasweb-site/&#96;)
- 
- ### Database Schema Updates
- 
- **File**: &#96;gasweb-site/supabase/migrations/[timestamp]_create_intake_nudge_schema.sql&#96;**New Tables:**
- 
- 1. &#96;lead_intake_events&#96; - Webhook ingestion
- 
- - Stores form submissions, cart events, page views
- 
- - Categorizes intent (High Value Lead, Window Shopper, etc.)
- 
- - Links to customer_profiles
- 
- 2. &#96;lead_states&#96; - State machine tracking
- 
- - Current state: new, engaged, ghosting, converted, lost
- 
- - State transitions with timestamps
- 
- - Context data (last activity, engagement score)
- 
- 3. &#96;nudge_campaigns&#96; - Re-engagement workflows
- 
- - Configurable delay timers
- 
- - Multi-stage sequences
- 
- - Channel preferences (email/SMS)
- 
- 4. &#96;nudge_executions&#96; - Campaign execution log
- 
- - Tracks sent nudges
- 
- - Response tracking
- 
- - Conversion attribution
- 
- ### Backend Services
- 
- **1. Webhook Handler**
- 
- - **File**: &#96;gasweb-site/supabase/functions/intake-webhook/index.ts&#96;
- 
- - Accepts webhooks from forms, Shopify, etc.
- 
- - Categorizes intent using rules engine
- 
- - Creates/updates lead_states
- 
- - Triggers immediate routing logic
- 
- **2. Intent Classification Service**
- 
- - **File**: &#96;gasweb-site/src/services/intentClassifier.ts&#96;
- 
- - Rules-based classification:
- 
- - High Value: Form with budget field, cart &gt; $X
- 
- - Window Shopper: Browse only, no form
- - Engaged: Multiple page views, form started
- 
- - Extensible for ML-based classification later
- 
- **3. Lead State Machine**
- 
- - **File**: &#96;gasweb-site/src/services/leadStateMachine.ts&#96;
- 
- - Manages state transitions:
- 
- - new → engaged (on first interaction)
- 
- - engaged → ghosting (after inactivity threshold)
- 
- - ghosting → converted (on purchase/booking)
- 
- - ghosting → lost (after max nudge attempts)
- 
- - Configurable thresholds per organization
- 
- **4. Nudge Automation Engine**
- 
- - **File**: &#96;gasweb-site/supabase/functions/nudge-processor/index.ts&#96;
- 
- - Scheduled function (runs every hour)
- 
- - Checks for leads in "ghosting" state past delay threshold
- 
- - Executes nudge campaigns based on workflow rules
- - Updates lead_states on response
- 
- ### Frontend Components
- 
- **1. Intake Dashboard**
- 
- - **File**: &#96;gasweb-site/src/pages/IntakeDashboard.tsx&#96;
- 
- - Real-time lead feed
- 
- - Intent classification display
- 
- - State distribution visualization
- 
- **2. Nudge Campaign Builder**
- 
- - **File**: &#96;gasweb-site/src/components/NudgeCampaignBuilder.tsx&#96;
- 
- - Visual workflow builder
- 
- - Delay configuration
- 
- - Channel selection
- 
- - A/B testing setup
- 
- ### Configuration
- 
- - **File**: &#96;gasweb-site/src/config/nudgeDefaults.ts&#96;
- 
- - Default delay timers
- 
- - State transition rules
- 
- - Intent classification thresholds
- 
- ## Integration Points
- 
- ### Cross-Phase Integration
- 
- 1. **Mission Control → God View**: Click customer in inbox → view full profile
- 
- 2. **God View → Intake**: Journey events include intake events
- 
- 3. **Intake → Mission Control**: New leads appear in dashboard
- 
- 4. **Nudge → Unified Inbox**: Nudge responses appear in threads
- 
- ### External Integrations
- 
- - Shopify webhooks (cart events, purchases)
- 
- - Form submission webhooks (custom forms)
- 
- - Email service (SendGrid/Mailgun for nudges)
- 
- - SMS service (Twilio for nudges)
- 
- - Social platforms (Instagram/Facebook DMs)
- 
- ## Data Flow Diagrams
- 
- ### Identity Resolution Flow
- 
- &#96;&#96;&#96;javascript
- Webhook/Form → Extract Identity → Check Existing Profiles
-   → Match Found? → Link Identity → Update Journey
-   → No Match → Create Profile → Link Identity → Create Journey Event
- &#96;&#96;&#96;
- 
- 
- 
- ### Nudge Automation Flow
- 
- &#96;&#96;&#96;javascript
- Scheduled Job → Query Ghosting Leads → Check Delay Threshold
-   → Threshold Met? → Load Nudge Campaign → Execute (Email/SMS)
-   → Update Execution Log → Update Lead State
- &#96;&#96;&#96;
- 
- 
- 
- ## Security &amp; RLS
- 
- - All new tables include &#96;organization_id&#96; for multi-tenant isolation
- 
- - RLS policies follow existing patterns (members can view, admins can manage)
- 
- - Webhook endpoints require organization-scoped authentication
- 
- - Identity resolution respects data privacy (no cross-org matching)
- 
- ## Testing Strategy
- 
- - Unit tests for identity resolution logic
- - Integration tests for webhook handlers
- 
- - E2E tests for nudge automation workflows
- 
- - Performance tests for real-time dashboard updates
- 
- ## Migration Notes
- 
- - Phase 1 migration includes data backfill scripts
- 
- - Phase 2 can run independently (doesn't require Phase 1)
+       - phase1-schema
+   - id: phase2-schema
+     content: Create Intake &amp; Nudge schema (lead_intake_events, lead_states, nudge_campaigns, nudge_executions)
+     status: pending
+   - id: phase2-webhook
+     content: Build webhook handler function for form/cart events with intent classification
+     status: pending
+     dependencies:
+       - phase2-schema
+   - id: phase2-state-machine
+     content: Implement lead state machine service with configurable transitions and thresholds
+     status: pending
+     dependencies:
+       - phase2-schema
+   - id: phase2-nudge-engine
+     content: Build nudge automation engine with scheduled processing and multi-channel execution
+     status: pending
+     dependencies:
+       - phase2-schema
+       - phase2-state-machine
+   - id: phase2-dashboard
+     content: Create IntakeDashboard page with real-time lead feed and state visualization
+     status: pending
+     dependencies:
+       - phase2-schema
+   - id: integration-testing
+     content: Test cross-phase integrations (Mission Control → God View, Intake → Inbox, etc.)
+     status: pending
+     dependencies:
+       - phase0-dashboard
+       - phase1-profile-view
+       - phase2-dashboard
+ ---
+ 
+ # God View Identity Layer &amp; Mission Control Dashboard Implementation Plan
+ 
+ ## Architecture Overview
+ 
+ This plan implements three critical phases of the Business Operating System:
+ - **Phase 0**: Mission Control Dashboard (command-center interface with tabbed layout)
+ - **Phase 1**: God View Identity Layer (unified customer profiles with linked identities)
+ - **Phase 2**: Intake &amp; Nudge Engine (proactive lead management)
+ 
+ ## UI/UX Design Reference
+ 
+ Based on the provided screenshots, the design follows these principles:
+ 
+ ### Mission Control Dashboard Design
+ - **Theme**: Dark theme with high-density information display
+ - **Layout**: Multi-panel grid layout (3-column: Left sidebar, Center, Right sidebar)
+ - **Color Scheme**: Dark background (#1a1a1a), green status indicators, blue accents
+ - **Typography**: Clear hierarchy with bold headers, readable body text
+ - **Visual Elements**: 
+   - Status dots (green = active, red = error)
+   - Progress bars for active conversations
+   - Icon-based channel indicators
+   - Real-time data updates
+ 
+ ### God View Customer Profile Design
+ - **Theme**: Dark theme matching Mission Control
+ - **Layout**: Top header with metrics, middle timeline, right sidebar summary
+ - **Key Features**:
+   - Linked identity badges (Shopify, Instagram, Phone, Email) with platform colors
+   - Chronological timeline with icons and timestamps
+   - Sentiment visualization with gradient bars
+   - Agent interaction history with conversation snippets
+ 
+ ---
+ 
+ ## Phase 0: Mission Control Dashboard (&#96;@project/&#96;)
+ 
+ ### Database Schema Updates
+ 
+ **File**: &#96;project/supabase/migrations/[timestamp]_create_mission_control_schema.sql&#96;
+ 
+ #### Core Tables
+ 
+ **1. &#96;communication_threads&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE communication_threads (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   customer_profile_id uuid REFERENCES customer_profiles(id) ON DELETE SET NULL,
+   contact_id uuid REFERENCES contacts(id) ON DELETE SET NULL,
+   thread_type text NOT NULL, -- 'email', 'sms', 'social', 'voice', 'mixed'
+   subject text,
+   priority text DEFAULT 'medium', -- 'low', 'medium', 'high', 'urgent'
+   status text DEFAULT 'open', -- 'open', 'assigned', 'resolved', 'archived'
+   assigned_to uuid REFERENCES auth.users(id),
+   assigned_agent_id uuid REFERENCES ai_agents(id),
+   human_online_status boolean DEFAULT false, -- For handoff logic
+   escalation_queue boolean DEFAULT false, -- For offline escalations
+   handoff_summary text, -- AI-generated summary for seamless handoff
+   handoff_timestamp timestamptz,
+   last_message_at timestamptz,
+   unread_count integer DEFAULT 0,
+   metadata jsonb DEFAULT '{}'::jsonb,
+   created_at timestamptz DEFAULT now(),
+   updated_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **2. &#96;communication_messages&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE communication_messages (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   thread_id uuid REFERENCES communication_threads(id) ON DELETE CASCADE NOT NULL,
+   channel text NOT NULL, -- 'email', 'sms', 'instagram', 'facebook', 'voice'
+   direction text NOT NULL, -- 'inbound', 'outbound'
+   sender_type text NOT NULL, -- 'customer', 'ai_agent', 'human'
+   sender_id uuid, -- customer_profile_id, agent_id, or user_id
+   recipient_id uuid,
+   subject text,
+   body text NOT NULL,
+   body_html text,
+   attachments jsonb DEFAULT '[]'::jsonb,
+   sentiment_score numeric(3,1), -- -10 to 10
+   sentiment_label text, -- 'positive', 'neutral', 'negative'
+   priority text DEFAULT 'medium',
+   is_read boolean DEFAULT false,
+   read_at timestamptz,
+   metadata jsonb DEFAULT '{}'::jsonb,
+   created_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **3. &#96;agent_performance_logs&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE agent_performance_logs (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   agent_id uuid REFERENCES ai_agents(id) ON DELETE CASCADE NOT NULL,
+   status text NOT NULL, -- 'active', 'idle', 'processing', 'paused', 'error', 'offline'
+   status_context text, -- e.g., 'handling 3 conversations', 'API timeout'
+   active_conversations integer DEFAULT 0,
+   current_task text,
+   success_rate numeric(5,2), -- Percentage
+   avg_response_time_seconds integer,
+   cost_per_interaction numeric(10,4),
+   customer_satisfaction_score numeric(3,1), -- 0-10
+   tasks_completed_24h integer DEFAULT 0,
+   tokens_used_24h integer DEFAULT 0,
+   errors_count_24h integer DEFAULT 0,
+   last_activity_at timestamptz,
+   logged_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **4. &#96;agent_transcripts&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE agent_transcripts (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   agent_id uuid REFERENCES ai_agents(id) ON DELETE CASCADE NOT NULL,
+   thread_id uuid REFERENCES communication_threads(id) ON DELETE SET NULL,
+   conversation_snippet text NOT NULL, -- Last 2-3 messages
+   full_transcript_url text, -- Link to full conversation if needed
+   sentiment_analysis jsonb,
+   intervention_required boolean DEFAULT false,
+   human_took_over boolean DEFAULT false,
+   takeover_timestamp timestamptz,
+   created_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **5. &#96;alert_rules&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE alert_rules (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   name text NOT NULL,
+   rule_type text NOT NULL, -- 'agent_failure', 'high_priority', 'performance_threshold', 'intervention_needed'
+   conditions jsonb NOT NULL, -- Threshold values, criteria
+   channels text[] DEFAULT ARRAY['dashboard'], -- 'dashboard', 'email', 'sms'
+   is_active boolean DEFAULT true,
+   created_by uuid REFERENCES auth.users(id),
+   created_at timestamptz DEFAULT now(),
+   updated_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **6. &#96;alert_history&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE alert_history (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   alert_rule_id uuid REFERENCES alert_rules(id) ON DELETE SET NULL,
+   alert_type text NOT NULL,
+   severity text DEFAULT 'medium', -- 'low', 'medium', 'high', 'critical'
+   title text NOT NULL,
+   message text NOT NULL,
+   context jsonb DEFAULT '{}'::jsonb,
+   is_acknowledged boolean DEFAULT false,
+   acknowledged_by uuid REFERENCES auth.users(id),
+   acknowledged_at timestamptz,
+   created_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **7. &#96;handoff_events&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE handoff_events (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   thread_id uuid REFERENCES communication_threads(id) ON DELETE CASCADE NOT NULL,
+   agent_id uuid REFERENCES ai_agents(id) ON DELETE SET NULL,
+   from_type text NOT NULL, -- 'ai_agent', 'human'
+   to_type text NOT NULL, -- 'ai_agent', 'human'
+   to_user_id uuid REFERENCES auth.users(id),
+   handoff_reason text, -- 'escalation', 'complex_query', 'agent_request'
+   summary text, -- AI-generated context summary
+   handoff_mode text NOT NULL, -- 'escalation' (offline), 'seamless' (online)
+   status text DEFAULT 'pending', -- 'pending', 'accepted', 'completed', 'resumed'
+   resumed_at timestamptz, -- When agent resumed after human handoff
+   created_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **8. &#96;human_online_status&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE human_online_status (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
+   is_online boolean DEFAULT false,
+   last_seen_at timestamptz DEFAULT now(),
+   status_message text,
+   available_for_handoff boolean DEFAULT true,
+   updated_at timestamptz DEFAULT now(),
+   UNIQUE(organization_id, user_id)
+ );
+ &#96;&#96;&#96;
+ 
+ #### Indexes
+ &#96;&#96;&#96;sql
+ CREATE INDEX idx_threads_org_customer ON communication_threads(organization_id, customer_profile_id);
+ CREATE INDEX idx_threads_status ON communication_threads(status, priority);
+ CREATE INDEX idx_messages_thread ON communication_messages(thread_id, created_at);
+ CREATE INDEX idx_agent_logs_agent_time ON agent_performance_logs(agent_id, logged_at DESC);
+ CREATE INDEX idx_agent_transcripts_agent ON agent_transcripts(agent_id, created_at DESC);
+ CREATE INDEX idx_alerts_org_unacknowledged ON alert_history(organization_id, is_acknowledged, created_at DESC);
+ CREATE INDEX idx_handoff_events_thread ON handoff_events(thread_id, created_at DESC);
+ &#96;&#96;&#96;
+ 
+ #### RLS Policies
+ - Organization-scoped access for all tables
+ - Members can view, admins can manage alert rules
+ - Real-time subscriptions enabled for agent logs and messages
+ 
+ ---
+ 
+ ### Frontend Components - Detailed Specifications
+ 
+ #### 1. Mission Control Dashboard Page
+ 
+ **File**: &#96;project/src/pages/MissionControl.tsx&#96;
+ 
+ **Layout**: Tabbed interface with 5 main sections
+ 
+ **Tab Structure**:
+ &#96;&#96;&#96;typescript
+ interface MissionControlTabs {
+   'command-center': {
+     title: 'Command Center',
+     icon: 'Command',
+     components: [AgentVisibility, PerformanceMetrics, SystemHealth]
+   },
+   'inbox': {
+     title: 'Unified Inbox',
+     icon: 'Inbox',
+     components: [UnifiedInbox]
+   },
+   'attention': {
+     title: 'Needs Attention',
+     icon: 'AlertCircle',
+     components: [EscalationQueue, InterventionQueue]
+   },
+   'analytics': {
+     title: 'Analytics',
+     icon: 'BarChart',
+     components: [HistoricalAnalytics]
+   },
+   'alerts': {
+     title: 'Alerts',
+     icon: 'Bell',
+     components: [AlertCenter]
+   }
+ }
+ &#96;&#96;&#96;
+ 
+ **Header Section** (All Tabs):
+ - Logo: "Neuro-Ops BOS" (or organization name)
+ - KPI Cards: Today's Sales, Active Conversations, AI Agents Online
+ - User profile dropdown
+ 
+ **Design Notes**:
+ - Dark theme (#1a1a1a background)
+ - High-density information display
+ - Real-time updates via Supabase subscriptions
+ - Desktop-first (1920px max width)
+ 
+ ---
+ 
+ #### 2. Agent Visibility Component
+ 
+ **File**: &#96;project/src/components/AgentVisibility.tsx&#96;
+ 
+ **Specifications**:
+ 
+ **Agent Status Display**:
+ - Status with context: &#96;"Voice Agent - Alpha: Talking - 2:34"&#96; or &#96;"Chatbot - Beta: Idle"&#96;
+ - Color-coded status dots:
+   - Green: Active/Idle
+   - Yellow: Processing
+   - Red: Error
+   - Gray: Offline/Paused
+ - Progress bar for active conversations showing duration
+ - Three-dot menu for actions (pause, resume, view details, configure)
+ 
+ **Live Transcripts Section**:
+ - Show last 2-3 active conversations per agent
+ - Display conversation snippet (truncated with ellipsis)
+ - "Takeover" button for each transcript
+ - Click to expand full conversation
+ 
+ **Performance Metrics (At-a-Glance)**:
+ - Success Rate: Percentage with trend indicator (↑/↓)
+ - Avg Response Time: Seconds with target comparison
+ - Cost Per Interaction: $ amount with daily total
+ - Customer Satisfaction: Sentiment score (0-10) with trend
+ 
+ **Real-time Updates**:
+ - Subscribe to &#96;agent_performance_logs&#96; table changes
+ - Update every 5 seconds for status
+ - Update on new transcript entries
+ 
+ **Props Interface**:
+ &#96;&#96;&#96;typescript
+ interface AgentVisibilityProps {
+   organizationId: string;
+   showMetrics?: boolean;
+   maxTranscripts?: number; // Default: 3
+ }
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ #### 3. Unified Inbox Component
+ 
+ **File**: &#96;project/src/components/UnifiedInbox.tsx&#96;
+ 
+ **Layout**: 3-column design (matching screenshot)
+ - Left: Channel filter sidebar
+ - Center: Customer threads list
+ - Right: Active conversation view
+ 
+ **Channel Sidebar** (Left):
+ - All Customers (people icon)
+ - SMS (icon with unread badge: "61")
+ - Facebook (FB icon)
+ - Instagram (IG icon)
+ - Email (envelope icon)
+ - Voice (phone icon)
+ 
+ **Customer Threads List** (Center):
+ - Profile picture or initials
+ - Customer name
+ - Last message preview (truncated)
+ - Timestamp ("2m ago", "Now")
+ - Unread indicator (red dot)
+ - Channel badge (SMS, Email, etc.)
+ 
+ **Active Conversation View** (Right):
+ - Customer header with profile info
+ - Message thread with:
+   - "AI Automated Response" badges
+   - "Human Reply" badges
+   - Timestamps
+   - Message content
+ - Reply input at bottom:
+   - Channel selector dropdown
+   - Text input
+   - Send button
+ 
+ **Filtering System**:
+ &#96;&#96;&#96;typescript
+ interface InboxFilters {
+   channels: ('email' | 'sms' | 'social' | 'voice')[];
+   status: ('unread' | 'assigned' | 'resolved')[];
+   agentType: ('ai' | 'human' | 'both');
+   priority: ('low' | 'medium' | 'high' | 'urgent')[];
+ }
+ &#96;&#96;&#96;
+ 
+ **Search System**:
+ - Search by: customer name, email, phone, conversation content
+ - Full-text search across message bodies
+ - Highlight matching terms
+ 
+ **Sort Options**:
+ - Most recent (default)
+ - Oldest unread
+ - Priority (high → low)
+ - Customer value (LTV descending)
+ 
+ **Props Interface**:
+ &#96;&#96;&#96;typescript
+ interface UnifiedInboxProps {
+   organizationId: string;
+   initialFilters?: Partial&lt;InboxFilters&gt;;
+   defaultSort?: SortOption;
+   onThreadSelect?: (threadId: string) =&gt; void;
+ }
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ #### 4. Escalation Queue Component
+ 
+ **File**: &#96;project/src/components/EscalationQueue.tsx&#96;
+ 
+ **Purpose**: Display threads where agent flagged for review but human is offline
+ 
+ **Display**:
+ - List of escalated threads
+ - Agent-generated summary
+ - Reason for escalation
+ - Time since escalation
+ - "Take Over" button
+ - Priority indicator
+ 
+ **Logic**:
+ - Query threads where &#96;escalation_queue = true&#96; AND &#96;human_online_status = false&#96;
+ - Auto-remove from queue when human comes online (moves to seamless handoff)
+ 
+ ---
+ 
+ #### 5. Handoff Interface Component
+ 
+ **File**: &#96;project/src/components/HandoffInterface.tsx&#96;
+ 
+ **Purpose**: Seamless handoff when human is online
+ 
+ **Flow**:
+ 1. Agent flags for review
+ 2. System checks &#96;human_online_status&#96;
+ 3. If online: Generate summary → Show notification → Display handoff modal
+ 4. Human sees:
+    - Conversation context
+    - AI-generated summary
+    - "Continue Conversation" button
+ 5. Human continues → Agent can resume later if needed
+ 
+ **Modal Content**:
+ - Thread preview
+ - Summary of conversation so far
+ - Key points extracted
+ - Sentiment analysis
+ - "Take Over" button
+ - "Let Agent Continue" button
+ 
+ ---
+ 
+ #### 6. Alert Center Component
+ 
+ **File**: &#96;project/src/components/AlertCenter.tsx&#96;
+ 
+ **Layout**:
+ - Active Alerts (unacknowledged)
+ - Alert History (acknowledged)
+ - Alert Rule Configuration
+ 
+ **Alert Types**:
+ 1. **Agent Failures**: Error status, API timeouts
+ 2. **High-Priority Messages**: Negative sentiment, VIP customer
+ 3. **Performance Thresholds**: Success rate &lt; X%, response time &gt; Y seconds
+ 4. **Intervention Needed**: Agent requests help
+ 
+ **Alert Display**:
+ - Severity badge (low/medium/high/critical)
+ - Title and message
+ - Context data (click to expand)
+ - Timestamp
+ - "Acknowledge" button
+ - "View Related" link
+ 
+ **Alert Rule Builder**:
+ - Rule type selector
+ - Condition builder (thresholds, criteria)
+ - Channel selection (dashboard, email, SMS)
+ - Active/inactive toggle
+ - Test button
+ 
+ ---
+ 
+ #### 7. Historical Analytics Component
+ 
+ **File**: &#96;project/src/components/HistoricalAnalytics.tsx&#96;
+ 
+ **Features**:
+ - Date range picker (default: last 30 days)
+ - Performance trends over time
+ - Agent comparison charts
+ - Channel performance breakdown
+ - Customer satisfaction trends
+ - Cost analysis
+ 
+ **Charts**:
+ - Line chart: Performance over time (matching screenshot style)
+ - Bar chart: Sales vs Abandoned Carts
+ - Pie chart: Channel distribution
+ - Heatmap: Agent activity by hour
+ 
+ ---
+ 
+ #### 8. Performance Metrics Widget
+ 
+ **File**: &#96;project/src/components/PerformanceMetricsWidget.tsx&#96;
+ 
+ **4-Metric Display** (matching requirements):
+ 1. **Success Rate**: 
+    - Large percentage number
+    - Trend indicator (↑/↓)
+    - Target comparison
+ 2. **Avg Response Time**:
+    - Seconds display
+    - Target line
+    - Trend indicator
+ 3. **Cost Per Interaction**:
+    - Dollar amount
+    - Daily total
+    - Trend indicator
+ 4. **Customer Satisfaction**:
+    - Score (0-10)
+    - Sentiment label
+    - Trend indicator
+ 
+ **Layout**: 2x2 grid or horizontal row (responsive)
+ 
+ ---
+ 
+ ### Hooks &amp; Services
+ 
+ #### 1. useAgentPerformance Hook
+ 
+ **File**: &#96;project/src/hooks/useAgentPerformance.ts&#96;
+ 
+ &#96;&#96;&#96;typescript
+ interface AgentPerformance {
+   agentId: string;
+   status: string;
+   statusContext: string;
+   activeConversations: number;
+   successRate: number;
+   avgResponseTime: number;
+   costPerInteraction: number;
+   customerSatisfaction: number;
+   lastActivity: Date;
+ }
+ 
+ export function useAgentPerformance(organizationId: string) {
+   // Real-time subscription to agent_performance_logs
+   // Returns: agents, loading, error, refetch
+ }
+ &#96;&#96;&#96;
+ 
+ #### 2. useUnifiedInbox Hook
+ 
+ **File**: &#96;project/src/hooks/useUnifiedInbox.ts&#96;
+ 
+ &#96;&#96;&#96;typescript
+ interface Thread {
+   id: string;
+   customerName: string;
+   customerAvatar?: string;
+   lastMessage: string;
+   lastMessageAt: Date;
+   unreadCount: number;
+   channel: string;
+   priority: string;
+   status: string;
+ }
+ 
+ export function useUnifiedInbox(
+   organizationId: string,
+   filters: InboxFilters,
+   searchQuery: string,
+   sortBy: SortOption
+ ) {
+   // Real-time subscription to communication_threads and messages
+   // Returns: threads, loading, error, refetch, sendMessage
+ }
+ &#96;&#96;&#96;
+ 
+ #### 3. useAlertSystem Hook
+ 
+ **File**: &#96;project/src/hooks/useAlertSystem.ts&#96;
+ 
+ &#96;&#96;&#96;typescript
+ export function useAlertSystem(organizationId: string) {
+   // Real-time subscription to alert_history
+   // Returns: activeAlerts, alertHistory, acknowledgeAlert, createRule
+ }
+ &#96;&#96;&#96;
+ 
+ #### 4. Communication Service
+ 
+ **File**: &#96;project/src/services/communicationService.ts&#96;
+ 
+ &#96;&#96;&#96;typescript
+ export class CommunicationService {
+   async sendMessage(
+     threadId: string,
+     channel: 'email' | 'sms' | 'social' | 'voice',
+     content: string,
+     senderType: 'human' | 'ai_agent'
+   ): Promise&lt;Message&gt;
+   
+   async escalateThread(threadId: string, reason: string): Promise&lt;void&gt;
+   
+   async handoffToHuman(threadId: string, summary: string): Promise&lt;HandoffEvent&gt;
+   
+   async resumeAgent(threadId: string): Promise&lt;void&gt;
+ }
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ ## Phase 1: God View Identity Layer (&#96;@project/&#96;)
+ 
+ ### Database Schema Updates
+ 
+ **File**: &#96;project/supabase/migrations/[timestamp]_create_god_view_identity_schema.sql&#96;
+ 
+ #### Core Tables
+ 
+ **1. &#96;customer_profiles&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE customer_profiles (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   contact_id uuid REFERENCES contacts(id) ON DELETE SET NULL,
+   -- Unified identity fields
+   primary_email text,
+   primary_phone text,
+   primary_name text, -- Full name
+   identity_confidence_score numeric(3,2) DEFAULT 1.0, -- 0.0 to 1.0
+   -- Aggregated data
+   lifetime_value numeric(15,2) DEFAULT 0,
+   total_orders integer DEFAULT 0,
+   last_active_at timestamptz,
+   status text DEFAULT 'active', -- 'active', 'inactive', 'lost', 'converted'
+   tags text[],
+   custom_fields jsonb DEFAULT '{}'::jsonb,
+   created_at timestamptz DEFAULT now(),
+   updated_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **2. &#96;identity_links&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE identity_links (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   customer_profile_id uuid REFERENCES customer_profiles(id) ON DELETE CASCADE NOT NULL,
+   platform text NOT NULL, -- 'shopify', 'instagram', 'email', 'phone', 'facebook', etc.
+   platform_id text NOT NULL, -- Platform-specific ID
+   platform_username text, -- e.g., Instagram handle
+   verification_status text DEFAULT 'verified', -- 'verified', 'unverified', 'pending'
+   metadata jsonb DEFAULT '{}'::jsonb,
+   first_seen_at timestamptz DEFAULT now(),
+   last_seen_at timestamptz DEFAULT now(),
+   created_at timestamptz DEFAULT now(),
+   UNIQUE(organization_id, platform, platform_id)
+ );
+ &#96;&#96;&#96;
+ 
+ **3. &#96;customer_journey_events&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE customer_journey_events (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   customer_profile_id uuid REFERENCES customer_profiles(id) ON DELETE CASCADE NOT NULL,
+   event_type text NOT NULL, -- 'ad_click', 'form_submit', 'cart_add', 'cart_abandon', 'purchase', 'email_open', 'sms_sent', etc.
+   platform text NOT NULL, -- 'shopify', 'instagram', 'email', 'website', etc.
+   platform_event_id text, -- Link to source event
+   title text NOT NULL, -- Human-readable title
+   description text,
+   metadata jsonb DEFAULT '{}'::jsonb,
+   value numeric(15,2), -- Monetary value if applicable
+   occurred_at timestamptz NOT NULL,
+   created_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **4. &#96;agent_interaction_logs&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE agent_interaction_logs (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   customer_profile_id uuid REFERENCES customer_profiles(id) ON DELETE CASCADE NOT NULL,
+   agent_id uuid REFERENCES ai_agents(id) ON DELETE SET NULL,
+   interaction_type text NOT NULL, -- 'voice_call', 'chat', 'email', 'sms'
+   thread_id uuid REFERENCES communication_threads(id) ON DELETE SET NULL,
+   voice_call_id uuid REFERENCES voice_agent_calls(id) ON DELETE SET NULL,
+   conversation_snippet text,
+   full_transcript_url text,
+   sentiment_score numeric(3,1), -- -10 to 10
+   sentiment_label text, -- 'positive', 'neutral', 'negative'
+   human_intervention_required boolean DEFAULT false,
+   human_intervened boolean DEFAULT false,
+   intervention_reason text,
+   outcome text, -- 'resolved', 'escalated', 'converted', 'lost'
+   duration_seconds integer,
+   tokens_used integer,
+   cost numeric(10,4),
+   started_at timestamptz NOT NULL,
+   ended_at timestamptz,
+   created_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ #### Indexes
+ &#96;&#96;&#96;sql
+ CREATE INDEX idx_customer_profiles_org_email ON customer_profiles(organization_id, primary_email);
+ CREATE INDEX idx_customer_profiles_org_phone ON customer_profiles(organization_id, primary_phone);
+ CREATE INDEX idx_identity_links_profile ON identity_links(customer_profile_id);
+ CREATE INDEX idx_identity_links_platform ON identity_links(platform, platform_id);
+ CREATE INDEX idx_journey_events_profile_time ON customer_journey_events(customer_profile_id, occurred_at DESC);
+ CREATE INDEX idx_agent_interactions_profile ON agent_interaction_logs(customer_profile_id, started_at DESC);
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ ### Identity Resolution Function
+ 
+ **File**: &#96;project/supabase/functions/resolve-customer-identity/index.ts&#96;
+ 
+ **Deterministic Matching Algorithm**:
+ 1. **Exact Email Match** (highest priority)
+    - Normalize email (lowercase, trim)
+    - Check &#96;customer_profiles.primary_email&#96;
+    - Check &#96;identity_links&#96; where platform = 'email'
+ 2. **Exact Phone Match**
+    - Normalize phone (remove formatting, country code)
+    - Check &#96;customer_profiles.primary_phone&#96;
+    - Check &#96;identity_links&#96; where platform = 'phone'
+ 3. **Name + Company Match** (fallback)
+    - Fuzzy matching on name + company
+    - Lower confidence score (0.7)
+ 4. **Create New Profile** if no match
+ 
+ **Function Signature**:
+ &#96;&#96;&#96;typescript
+ interface IdentityResolutionRequest {
+   organizationId: string;
+   email?: string;
+   phone?: string;
+   name?: string;
+   company?: string;
+   platform: string;
+   platformId: string;
+ }
+ 
+ interface IdentityResolutionResponse {
+   customerProfileId: string;
+   matched: boolean;
+   confidenceScore: number;
+   identityLinks: IdentityLink[];
+ }
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ ### Frontend Components
+ 
+ #### 1. Customer Profile View
+ 
+ **File**: &#96;project/src/pages/CustomerProfile.tsx&#96;
+ 
+ **Layout** (matching screenshot):
+ - **Top Section**: 
+   - Customer name header
+   - Lifetime Value badge
+   - Status badge (Active Lead, etc.)
+   - Last Active timestamp
+   - Linked Identities row (Shopify, Instagram, Phone, Email icons)
+ - **Middle Section**: 
+   - Unified Activity Timeline (vertical timeline with events)
+   - Chronological events with icons, timestamps, descriptions
+ - **Right Section**: 
+   - Agent History Summary
+   - Conversation snippets
+   - Sentiment Score with gradient visualization
+ 
+ **Linked Identities Display**:
+ - Platform-specific icons with colors:
+   - Shopify: Green
+   - Instagram: Orange/Pink gradient
+   - Phone: Blue
+   - Email: Blue
+ - Platform ID or username
+ - Verification badge
+ 
+ **Unified Timeline**:
+ - Vertical line connecting events
+ - Event cards with:
+   - Timestamp (relative: "2m ago", "Yesterday 4:30 PM")
+   - Platform icon
+   - Event title
+   - Event description
+   - Metadata (if applicable)
+ 
+ **Agent History**:
+ - Conversation snippets (last interaction)
+ - Sentiment score (0-10) with label
+ - Gradient bar visualization (purple → green)
+ - Link to full conversation
+ 
+ **Props Interface**:
+ &#96;&#96;&#96;typescript
+ interface CustomerProfileProps {
+   customerProfileId: string;
+   organizationId: string;
+ }
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ #### 2. Identity Resolution Service
+ 
+ **File**: &#96;project/src/services/identityResolution.ts&#96;
+ 
+ **Functions**:
+ - &#96;resolveIdentity(data: IdentityData): Promise&lt;CustomerProfile&gt;&#96;
+ - &#96;mergeProfiles(profileIds: string[]): Promise&lt;CustomerProfile&gt;&#96;
+ - &#96;linkIdentity(profileId: string, platform: string, platformId: string): Promise&lt;void&gt;&#96;
+ - &#96;unlinkIdentity(linkId: string): Promise&lt;void&gt;&#96;
+ 
+ ---
+ 
+ ### Hooks
+ 
+ #### 1. useCustomerProfile Hook
+ 
+ **File**: &#96;project/src/hooks/useCustomerProfile.ts&#96;
+ 
+ &#96;&#96;&#96;typescript
+ export function useCustomerProfile(
+   customerProfileId: string,
+   organizationId: string
+ ) {
+   // Returns: profile, identityLinks, loading, error, updateProfile
+ }
+ &#96;&#96;&#96;
+ 
+ #### 2. useCustomerJourney Hook
+ 
+ **File**: &#96;project/src/hooks/useCustomerJourney.ts&#96;
+ 
+ &#96;&#96;&#96;typescript
+ export function useCustomerJourney(
+   customerProfileId: string,
+   dateRange?: { start: Date; end: Date }
+ ) {
+   // Returns: events, loading, error, refetch
+ }
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ ## Phase 2: Intake &amp; Nudge Engine (&#96;@gasweb-site/&#96;)
+ 
+ ### Database Schema Updates
+ 
+ **File**: &#96;gasweb-site/supabase/migrations/[timestamp]_create_intake_nudge_schema.sql&#96;
+ 
+ #### Core Tables
+ 
+ **1. &#96;lead_intake_events&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE lead_intake_events (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   customer_profile_id uuid REFERENCES customer_profiles(id) ON DELETE SET NULL,
+   event_type text NOT NULL, -- 'form_submit', 'cart_add', 'cart_abandon', 'page_view', 'button_click'
+   source text NOT NULL, -- 'shopify', 'website', 'landing_page', 'form'
+   source_event_id text, -- External event ID
+   intent_category text, -- 'high_value', 'window_shopper', 'engaged', 'browsing'
+   intent_score integer, -- 0-100
+   event_data jsonb NOT NULL, -- Full event payload
+   metadata jsonb DEFAULT '{}'::jsonb,
+   created_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **2. &#96;lead_states&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE lead_states (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   customer_profile_id uuid REFERENCES customer_profiles(id) ON DELETE CASCADE NOT NULL,
+   current_state text NOT NULL, -- 'new', 'engaged', 'ghosting', 'converted', 'lost'
+   previous_state text,
+   state_transitions jsonb DEFAULT '[]'::jsonb, -- Array of {state, timestamp, reason}
+   last_activity_at timestamptz,
+   engagement_score integer DEFAULT 0, -- 0-100
+   ghosting_started_at timestamptz, -- When entered ghosting state
+   nudge_attempts integer DEFAULT 0,
+   max_nudge_attempts integer DEFAULT 3,
+   context_data jsonb DEFAULT '{}'::jsonb,
+   created_at timestamptz DEFAULT now(),
+   updated_at timestamptz DEFAULT now(),
+   UNIQUE(organization_id, customer_profile_id)
+ );
+ &#96;&#96;&#96;
+ 
+ **3. &#96;nudge_campaigns&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE nudge_campaigns (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   name text NOT NULL,
+   description text,
+   trigger_state text NOT NULL, -- 'ghosting'
+   delay_hours integer NOT NULL, -- Configurable delay before nudge
+   channel text NOT NULL, -- 'email', 'sms', 'both'
+   content_template jsonb NOT NULL, -- Email/SMS templates
+   sequence_steps jsonb DEFAULT '[]'::jsonb, -- Multi-stage sequence
+   is_active boolean DEFAULT true,
+   total_sent integer DEFAULT 0,
+   total_converted integer DEFAULT 0,
+   created_by uuid REFERENCES auth.users(id),
+   created_at timestamptz DEFAULT now(),
+   updated_at timestamptz DEFAULT now()
+ );
+ &#96;&#96;&#96;
+ 
+ **4. &#96;nudge_executions&#96;**
+ &#96;&#96;&#96;sql
+ CREATE TABLE nudge_executions (
+   id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
+   organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
+   campaign_id uuid REFERENCES nudge_campaigns(id) ON DELETE SET NULL,
+   customer_profile_id uuid REFERENCES customer_profiles(id) ON DELETE CASCADE NOT NULL,
+   lead_state_id uuid REFERENCES lead_states(id) ON DELETE CASCADE NOT NULL,
+   channel text NOT NULL, -- 'email', 'sms'
+   content text NOT NULL,
+   sent_at timestamptz DEFAULT now(),
+   delivered_at timestamptz,
+   opened_at timestamptz,
+   clicked_at timestamptz,
+   responded_at timestamptz,
+   converted_at timestamptz,
+   status text DEFAULT 'sent', -- 'sent', 'delivered', 'opened', 'clicked', 'responded', 'converted', 'failed'
+   error_message text,
+   metadata jsonb DEFAULT '{}'::jsonb
+ );
+ &#96;&#96;&#96;
+ 
+ #### Indexes
+ &#96;&#96;&#96;sql
+ CREATE INDEX idx_lead_intake_events_profile ON lead_intake_events(customer_profile_id, created_at DESC);
+ CREATE INDEX idx_lead_states_state ON lead_states(current_state, ghosting_started_at);
+ CREATE INDEX idx_nudge_executions_profile ON nudge_executions(customer_profile_id, sent_at DESC);
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ ### Backend Services
+ 
+ #### 1. Webhook Handler
+ 
+ **File**: &#96;gasweb-site/supabase/functions/intake-webhook/index.ts&#96;
+ 
+ **Supported Webhooks**:
+ - Shopify: cart events, purchases, customer updates
+ - Form submissions: Custom forms, landing pages
+ - Page views: Website tracking
+ 
+ **Flow**:
+ 1. Receive webhook payload
+ 2. Extract identity (email, phone, name)
+ 3. Resolve customer profile (use Phase 1 function)
+ 4. Classify intent
+ 5. Create/update lead_state
+ 6. Trigger immediate routing if needed
+ 
+ #### 2. Intent Classification Service
+ 
+ **File**: &#96;gasweb-site/src/services/intentClassifier.ts&#96;
+ 
+ **Rules-Based Classification**:
+ - **High Value**: Form with budget field, cart value &gt; $X, enterprise plan interest
+ - **Window Shopper**: Browse only, no form, multiple page views but no engagement
+ - **Engaged**: Form started, multiple interactions, email opened
+ - **Browsing**: Single page view, no form interaction
+ 
+ **Scoring**: 0-100 intent score
+ 
+ #### 3. Lead State Machine
+ 
+ **File**: &#96;gasweb-site/src/services/leadStateMachine.ts&#96;
+ 
+ **State Transitions**:
+ - &#96;new&#96; → &#96;engaged&#96; (on first meaningful interaction)
+ - &#96;engaged&#96; → &#96;ghosting&#96; (after inactivity threshold - configurable)
+ - &#96;ghosting&#96; → &#96;converted&#96; (on purchase/booking)
+ - &#96;ghosting&#96; → &#96;lost&#96; (after max nudge attempts)
+ - &#96;engaged&#96; → &#96;converted&#96; (direct conversion)
+ 
+ **Configurable Thresholds** (per organization):
+ - Inactivity threshold (hours)
+ - Max nudge attempts
+ - Engagement score thresholds
+ 
+ #### 4. Nudge Automation Engine
+ 
+ **File**: &#96;gasweb-site/supabase/functions/nudge-processor/index.ts&#96;
+ 
+ **Scheduled Function** (runs every hour):
+ 1. Query leads in &#96;ghosting&#96; state
+ 2. Check if &#96;ghosting_started_at + delay_hours&#96; has passed
+ 3. Check if &#96;nudge_attempts &lt; max_nudge_attempts&#96;
+ 4. Load active nudge campaigns
+ 5. Execute nudge (email/SMS)
+ 6. Create &#96;nudge_execution&#96; record
+ 7. Update &#96;lead_state.nudge_attempts&#96;
+ 8. Update &#96;lead_state&#96; if converted
+ 
+ ---
+ 
+ ### Frontend Components
+ 
+ #### 1. Intake Dashboard
+ 
+ **File**: &#96;gasweb-site/src/pages/IntakeDashboard.tsx&#96;
+ 
+ **Features**:
+ - Real-time lead feed
+ - Intent classification badges
+ - State distribution visualization (pie chart)
+ - Lead timeline
+ - Quick actions (assign, tag, convert)
+ 
+ #### 2. Nudge Campaign Builder
+ 
+ **File**: &#96;gasweb-site/src/components/NudgeCampaignBuilder.tsx&#96;
+ 
+ **Features**:
+ - Visual workflow builder
+ - Delay configuration (hours)
+ - Channel selection (email/SMS/both)
+ - Template editor
+ - A/B testing setup
+ - Preview mode
+ 
+ ---
+ 
+ ## Integration Points
+ 
+ ### Cross-Phase Integration
+ 
+ 1. **Mission Control → God View**: 
+    - Click customer name in inbox → Navigate to CustomerProfile page
+    - Show customer profile preview in sidebar
+ 
+ 2. **God View → Intake**: 
+    - Journey events include intake events
+    - Show lead state in customer profile
+ 
+ 3. **Intake → Mission Control**: 
+    - New high-value leads appear in "Needs Attention" tab
+    - Lead conversion updates revenue metrics
+ 
+ 4. **Nudge → Unified Inbox**: 
+    - Nudge responses create new threads
+    - Track nudge effectiveness in analytics
+ 
+ ---
+ 
+ ## Security &amp; RLS
+ 
+ - All tables include &#96;organization_id&#96; for multi-tenant isolation
+ - RLS policies follow existing patterns:
+   - Members can view
+   - Admins can manage
+   - System functions can create/update
+ - Webhook endpoints require organization-scoped authentication
+ - Identity resolution respects data privacy (no cross-org matching)
+ 
+ ---
+ 
+ ## Testing Strategy
+ 
+ - Unit tests for identity resolution logic
+ - Integration tests for webhook handlers
+ - E2E tests for nudge automation workflows
+ - Performance tests for real-time dashboard updates
+ - Load tests for alert system
+ 
+ ---
+ 
+ ## Migration Notes
+ 
+ - Phase 0: Additive schema changes, no data migration needed
+ - Phase 1: Includes data backfill scripts to migrate contacts → customer_profiles
+ - Phase 2: Can run independently (doesn't require Phase 1, but benefits from it)
+ 
+ ---
+ 
+ ## Design System Notes
+ 
+ ### Color Palette (Dark Theme)
+ - Background: #1a1a1a (primary), #252525 (secondary)
+ - Text: #ffffff (primary), #b0b0b0 (secondary)
+ - Accents: 
+   - Blue: #3b82f6 (primary actions)
+   - Green: #10b981 (success, active)
+   - Red: #ef4444 (errors, critical)
+   - Yellow: #f59e0b (warnings)
+ - Platform Colors:
+   - Shopify: #96bf48
+   - Instagram: #E4405F
+   - Facebook: #1877F2
+   - Email: #4285F4
+ 
+ ### Typography
+ - Headers: Bold, 18-24px
+ - Body: Regular, 14-16px
+ - Small text: 12px
+ - Monospace: For timestamps, IDs
+ 
+ ### Spacing
+ - Grid: 8px base unit
+ - Padding: 16px (standard), 24px (sections)
+ - Gaps: 12px (small), 16px (medium), 24px (large)
+ 
+ ### Components
+ - Status dots: 8px circle
+ - Badges: Rounded, 4-8px padding
+ - Cards: Rounded corners (8px), subtle shadow
+ - Buttons: 44px min height (touch-friendly)
+ 
```

</details>

</tool-use>

---



---


Updated the plan with detailed specifications. Summary of additions:

## Plan updates

### 1. Database schema
- 8 new tables for Mission Control (including alert system, handoff events, human online status)
- 4 tables for God View identity layer
- 4 tables for Intake & Nudge engine
- Indexes and RLS policies defined

### 2. Component specifications
- Agent Visibility: Contextual status display ("Talking - 2:34", "Idle")
- Unified Inbox: 3-column layout with filtering, search, and sorting
- Escalation Queue: Offline escalation handling
- Handoff Interface: Seamless handoff when human is online
- Alert Center: Configurable alert rules and notification system
- Performance Metrics: 4-metric dashboard (success rate, response time, cost, satisfaction)

### 3. UI/UX design notes
- Dark theme color palette (#1a1a1a background)
- Platform-specific icon colors (Shopify green, Instagram orange, etc.)
- Layout patterns matching your screenshots
- Typography and spacing guidelines
- Desktop-first approach (1920px max width)

### 4. Tabbed layout structure
Five main tabs:
1. Command Center: Agent grid + performance metrics
2. Unified Inbox: All conversations
3. Needs Attention: Escalations + interventions
4. Analytics: Historical data with date range filters
5. Alerts: Active alerts + rule configuration

### 5. Feature specifications
- Agent status with context (e.g., "active (handling 3 conversations)")
- Full filtering/search/sort for inbox
- Dual-mode handoff (escalation vs seamless)
- Configurable alerts (4 types)
- Full history with date range filters

### 6. Integration flows
- Mission Control → God View navigation
- Intake events → Journey timeline
- Nudge responses → Unified Inbox threads

## Next steps

The plan is ready for implementation. It includes:
- Database migration scripts (SQL ready to execute)
- Component interfaces (TypeScript interfaces defined)
- Hook specifications (React hooks with return types)
- Service layer architecture (class structures)
- Design system guidelines (colors, typography, spacing)

Should I:
1. Create the actual database migration files?
2. Generate the component skeleton code?
3. Create the hook implementations?
4. Start with a specific phase?

Which would you like me to prioritize?

---

